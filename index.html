<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MANNA - ìë™ì €ì¥</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        function MannaTracker() {
            const [allData, setAllData] = useState({});
            const [currentDate, setCurrentDate] = useState('');
            const [currentText, setCurrentText] = useState('');
            const [currentMemo, setCurrentMemo] = useState('');
            const [copied, setCopied] = useState(false);
            const [viewMonth, setViewMonth] = useState('');
            const [lastSaved, setLastSaved] = useState(null);
            const [shareUrl, setShareUrl] = useState('');
            const [showShareModal, setShowShareModal] = useState(false);

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const STORAGE_KEY = 'manna_data_v2';

            // ì´ˆê¸° ë¡œë“œ: localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setAllData(parsed.allData || {});
                        setLastSaved(new Date(parsed.lastSaved));
                    } catch (e) {
                        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                    }
                }

                const today = new Date();
                const todayStr = formatDate(today);
                setCurrentDate(todayStr);
                setViewMonth(todayStr.substring(0, 7));

                // URLì—ì„œ ê³µìœ ëœ ë°ì´í„° í™•ì¸
                loadFromUrl();
            }, []);

            // ë°ì´í„° ë³€ê²½ì‹œ ìë™ ì €ì¥
            useEffect(() => {
                if (Object.keys(allData).length > 0) {
                    saveToLocalStorage();
                }
            }, [allData]);

            useEffect(() => {
                if (currentDate) {
                    loadDate(currentDate);
                }
            }, [currentDate]);

            function saveToLocalStorage() {
                const dataToSave = {
                    allData: allData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                setLastSaved(new Date());
            }

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getDayOfWeek(dateStr) {
                if (!dateStr) return '';
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                return dayNames[date.getDay()];
            }

            function getWeekNumber(dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const firstDay = new Date(year, 0, 1);
                const pastDays = (date - firstDay) / 86400000;
                return Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            }

            function loadDate(dateStr) {
                if (allData[dateStr]) {
                    setCurrentText(allData[dateStr].text || '');
                    setCurrentMemo(allData[dateStr].memo || '');
                } else {
                    setCurrentText('');
                    setCurrentMemo('');
                }
            }

            function saveCurrentDate() {
                if (currentDate && (currentText || currentMemo)) {
                    setAllData(prev => ({
                        ...prev,
                        [currentDate]: {
                            text: currentText,
                            memo: currentMemo,
                            dayOfWeek: getDayOfWeek(currentDate),
                            weekNumber: getWeekNumber(currentDate)
                        }
                    }));
                }
            }

            function handleDateChange(newDate) {
                saveCurrentDate();
                setCurrentDate(newDate);
                setViewMonth(newDate.substring(0, 7));
            }

            function goToToday() {
                const today = new Date();
                handleDateChange(formatDate(today));
            }

            function changeDay(offset) {
                if (!currentDate) {
                    goToToday();
                    return;
                }
                const [year, month, day] = currentDate.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                date.setDate(date.getDate() + offset);
                handleDateChange(formatDate(date));
            }

            function changeMonth(offset) {
                const [year, month] = viewMonth.split('-').map(Number);
                const newDate = new Date(year, month - 1 + offset, 1);
                setViewMonth(formatDate(newDate).substring(0, 7));
            }

            function getMonthCalendar(yearMonth) {
                const [year, month] = yearMonth.split('-').map(Number);
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0).getDate();
                const startDayOfWeek = firstDay.getDay();
                
                const calendar = [];
                
                for (let i = 0; i < startDayOfWeek; i++) {
                    calendar.push({ empty: true, key: `empty-${i}` });
                }
                
                for (let day = 1; day <= lastDay; day++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    calendar.push({
                        empty: false,
                        date: dateStr,
                        day: day,
                        hasData: !!allData[dateStr],
                        key: dateStr
                    });
                }
                
                return calendar;
            }

            function exportAllData() {
                saveCurrentDate();
                const data = {
                    allData: allData,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().slice(0, 10);
                a.download = `MANNA_ë°±ì—…_${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function exportCombinedText() {
                saveCurrentDate();
                let combinedText = `MANNA ì „ì²´ ë…¹ì·¨\n\n`;
                
                const sortedDates = Object.keys(allData).sort();
                let currentYear = null;
                let currentWeek = null;

                sortedDates.forEach(date => {
                    const entry = allData[date];
                    if (!entry.text) return;
                    
                    const [year, month, day] = date.split('-');
                    const weekNum = entry.weekNumber;
                    
                    if (currentYear !== year) {
                        currentYear = year;
                        combinedText += `\n${'='.repeat(60)}\n${year}ë…„\n${'='.repeat(60)}\n\n`;
                    }
                    
                    if (currentWeek !== weekNum) {
                        currentWeek = weekNum;
                        combinedText += `\n[ ${weekNum}ì£¼ì°¨ ]\n\n`;
                    }
                    
                    combinedText += `ã€${entry.dayOfWeek}ìš”ì¼ ${month}/${day}ã€‘\n${entry.text}\n\n`;
                });

                const blob = new Blob([combinedText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().slice(0, 10);
                a.download = `MANNA_ì „ì²´ë…¹ì·¨_${timestamp}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function importData(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            const importedData = data.allData || {};
                            
                            // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ë®ì–´ì“°ê¸° í™•ì¸)
                            if (Object.keys(allData).length > 0) {
                                if (!confirm('ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì·¨ì†Œí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤)')) {
                                    setAllData(importedData);
                                } else {
                                    setAllData(prev => ({ ...prev, ...importedData }));
                                }
                            } else {
                                setAllData(importedData);
                            }
                            
                            if (currentDate && importedData[currentDate]) {
                                loadDate(currentDate);
                            }
                            alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                        } catch (error) {
                            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            }

            async function generateShareUrl() {
                saveCurrentDate();
                const data = {
                    allData: allData,
                    exportDate: new Date().toISOString()
                };
                
                try {
                    const compressed = btoa(encodeURIComponent(JSON.stringify(data)));
                    const url = `${window.location.origin}${window.location.pathname}#share=${compressed}`;
                    setShareUrl(url);
                    setShowShareModal(true);
                } catch (err) {
                    alert('URL ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.');
                }
            }

            function loadFromUrl() {
                const hash = window.location.hash;
                if (hash.startsWith('#share=')) {
                    try {
                        const compressed = hash.substring(7);
                        const decoded = JSON.parse(decodeURIComponent(atob(compressed)));
                        
                        if (Object.keys(allData).length > 0) {
                            if (confirm('ê³µìœ ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©ë©ë‹ˆë‹¤)')) {
                                setAllData(prev => ({ ...prev, ...decoded.allData }));
                                alert('ê³µìœ  ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                            }
                        } else {
                            setAllData(decoded.allData);
                            alert('ê³µìœ  ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                        }
                        
                        window.location.hash = '';
                    } catch (err) {
                        console.error('ê³µìœ  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                    }
                }
            }

            async function copyShareUrl() {
                try {
                    await navigator.clipboard.writeText(shareUrl);
                    alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (err) {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async function copyToClipboard() {
                saveCurrentDate();
                const data = {
                    allData: allData,
                    exportDate: new Date().toISOString()
                };
                try {
                    await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            const totalEntries = Object.keys(allData).length;
            const monthCalendar = viewMonth ? getMonthCalendar(viewMonth) : [];
            const monthStats = {
                written: monthCalendar.filter(d => !d.empty && d.hasData).length
            };
            const dayOfWeek = getDayOfWeek(currentDate);
            const weekNum = currentDate ? getWeekNumber(currentDate) : null;

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Column */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* Header */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4 flex-wrap gap-4">
                                        <div className="flex items-center gap-3">
                                            <div className="text-4xl">ğŸ</div>
                                            <div>
                                                <h1 className="text-3xl font-bold text-amber-800">MANNA</h1>
                                                <p className="text-sm text-gray-600">
                                                    ì´ {totalEntries}ì¼ ê¸°ë¡
                                                    {lastSaved && (
                                                        <span className="ml-2 text-green-600">
                                                            âœ“ ìë™ì €ì¥ë¨
                                                        </span>
                                                    )}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 flex-wrap">
                                            <button 
                                                onClick={generateShareUrl} 
                                                title="ë””ë°”ì´ìŠ¤ ê°„ ê³µìœ  ë§í¬ ìƒì„±" 
                                                className="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm font-semibold"
                                            >
                                                ğŸ”— ê³µìœ 
                                            </button>
                                            <button 
                                                onClick={copyToClipboard} 
                                                title="JSON ë°ì´í„° ë³µì‚¬" 
                                                className="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm"
                                            >
                                                {copied ? 'âœ“' : 'ğŸ“‹'}
                                            </button>
                                            <button 
                                                onClick={exportAllData} 
                                                title="ë°±ì—… íŒŒì¼ ì €ì¥" 
                                                className="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                            >
                                                ğŸ’¾
                                            </button>
                                            <button 
                                                onClick={exportCombinedText} 
                                                title="í…ìŠ¤íŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°" 
                                                className="px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-sm"
                                            >
                                                ğŸ“„
                                            </button>
                                            <label 
                                                title="ë°±ì—… íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°" 
                                                className="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors cursor-pointer text-sm"
                                            >
                                                ğŸ“‚
                                                <input type="file" accept=".json" onChange={importData} className="hidden" />
                                            </label>
                                        </div>
                                    </div>

                                    {/* Date Input */}
                                    <div className="flex gap-3 items-center mb-4">
                                        <button onClick={() => changeDay(-1)} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-bold">
                                            â—€
                                        </button>
                                        <input
                                            type="date"
                                            value={currentDate}
                                            onChange={(e) => handleDateChange(e.target.value)}
                                            className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none text-lg font-semibold"
                                        />
                                        <button onClick={goToToday} className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                                            ì˜¤ëŠ˜
                                        </button>
                                        <button onClick={() => changeDay(1)} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-bold">
                                            â–¶
                                        </button>
                                    </div>

                                    {currentDate && (
                                        <div className="text-center mb-2">
                                            <span className="text-2xl font-bold text-gray-800">{dayOfWeek}ìš”ì¼</span>
                                            {weekNum && <span className="text-gray-500 ml-3">({weekNum}ì£¼ì°¨)</span>}
                                        </div>
                                    )}
                                </div>

                                {/* Main Input */}
                                {currentDate && (
                                    <div className="bg-white rounded-lg shadow-md p-5">
                                        <div className="mb-3">
                                            <h3 className="text-xl font-semibold text-gray-800">
                                                {currentDate} ({dayOfWeek}ìš”ì¼)
                                            </h3>
                                        </div>
                                        <textarea
                                            value={currentText}
                                            onChange={(e) => setCurrentText(e.target.value)}
                                            placeholder="ì˜¤ëŠ˜ì˜ ë…¹ì·¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (ìë™ ì €ì¥ë©ë‹ˆë‹¤)"
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none resize-none"
                                            rows={10}
                                            onBlur={saveCurrentDate}
                                        />
                                        {currentText && (
                                            <div className="mt-2 text-sm text-gray-600">{currentText.length}ì</div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Right Column */}
                            <div className="space-y-6">
                                {/* Calendar */}
                                <div className="bg-white rounded-lg shadow-lg p-5">
                                    <div className="flex items-center justify-between mb-4">
                                        <button onClick={() => changeMonth(-1)} className="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                                            â—€
                                        </button>
                                        <h3 className="text-lg font-bold text-gray-800">
                                            {viewMonth && viewMonth.replace('-', 'ë…„ ')}ì›”
                                        </h3>
                                        <button onClick={() => changeMonth(1)} className="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                                            â–¶
                                        </button>
                                    </div>

                                    <div className="mb-4 p-3 bg-amber-50 rounded-lg text-center">
                                        <div className="text-lg">
                                            <span className="text-green-600 font-bold text-2xl">{monthStats.written}</span>
                                            <span className="text-gray-600 ml-2">ì¼ ì‘ì„±</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-7 gap-1 mb-2">
                                        <div className="text-center text-xs font-semibold text-red-500 py-1">ì¼</div>
                                        <div className="text-center text-xs font-semibold text-gray-600 py-1">ì›”</div>
                                        <div className="text-center text-xs font-semibold text-gray-600 py-1">í™”</div>
                                        <div className="text-center text-xs font-semibold text-gray-600 py-1">ìˆ˜</div>
                                        <div className="text-center text-xs font-semibold text-gray-600 py-1">ëª©</div>
                                        <div className="text-center text-xs font-semibold text-gray-600 py-1">ê¸ˆ</div>
                                        <div className="text-center text-xs font-semibold text-blue-600 py-1">í† </div>
                                    </div>

                                    <div className="grid grid-cols-7 gap-1">
                                        {monthCalendar.map((item) => 
                                            item.empty ? (
                                                <div key={item.key} className="p-2"></div>
                                            ) : (
                                                <button
                                                    key={item.key}
                                                    onClick={() => handleDateChange(item.date)}
                                                    className={`p-2 rounded-lg text-center transition-all ${
                                                        item.date === currentDate
                                                            ? 'bg-amber-500 text-white font-bold ring-2 ring-amber-600'
                                                            : item.hasData
                                                            ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                                            : 'bg-red-50 text-red-500 hover:bg-red-100'
                                                    }`}
                                                >
                                                    <div className="font-bold">{item.day}</div>
                                                </button>
                                            )
                                        )}
                                    </div>

                                    <div className="mt-4 text-xs space-y-1">
                                        <div className="flex items-center gap-2">
                                            <div className="w-4 h-4 bg-green-100 rounded"></div>
                                            <span>ì‘ì„± ì™„ë£Œ</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="w-4 h-4 bg-red-50 rounded"></div>
                                            <span>ë¯¸ì‘ì„±</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Memo */}
                                <div className="bg-white rounded-lg shadow-md p-5">
                                    <h3 className="font-semibold text-gray-800 mb-3">ğŸ“ ê°„ë‹¨ ë©”ëª¨</h3>
                                    {currentDate ? (
                                        <div>
                                            <div className="text-sm text-gray-600 mb-2">
                                                {currentDate} ({dayOfWeek}ìš”ì¼)
                                            </div>
                                            <textarea
                                                value={currentMemo}
                                                onChange={(e) => setCurrentMemo(e.target.value)}
                                                onBlur={saveCurrentDate}
                                                placeholder="ì˜¤ëŠ˜ì˜ ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none resize-none text-sm"
                                                rows={4}
                                            />
                                            {currentMemo && (
                                                <div className="mt-1 text-xs text-gray-500">{currentMemo.length}ì</div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="text-sm text-gray-500 text-center py-4">
                                            ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ë©”ëª¨ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Share Modal */}
                    {showShareModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                <h2 className="text-2xl font-bold mb-4 text-amber-800">ğŸ”— ê³µìœ  ë§í¬</h2>
                                <p className="text-gray-600 mb-4">
                                    ì´ ë§í¬ë¥¼ ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤(í°, PC ë“±)ì—ì„œ ì—´ë©´ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                                </p>
                                <div className="bg-gray-100 p-3 rounded-lg mb-4 break-all text-sm">
                                    {shareUrl}
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={copyShareUrl}
                                        className="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
                                    >
                                        ğŸ“‹ ë§í¬ ë³µì‚¬
                                    </button>
                                    <button
                                        onClick={() => setShowShareModal(false)}
                                        className="flex-1 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400"
                                    >
                                        ë‹«ê¸°
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-4">
                                    âš ï¸ ì£¼ì˜: ë§í¬ê°€ ë§¤ìš° ê¸¸ ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„°ê°€ ë§ìœ¼ë©´ ë§í¬ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                                    ê·¸ëŸ´ ê²½ìš° ë°±ì—… íŒŒì¼(ğŸ’¾)ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MannaTracker />);
    </script>
</body>
</html>


